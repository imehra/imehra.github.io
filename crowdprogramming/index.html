<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>Project 4</title>
<div class = "header_centered">
Project 4: Rocketship Game
</div>
<header> Use the right and left arrow keys to control the ship. Avoid the explosions and reach $2 to win! </header>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="mturk.js"></script>


<script>
var piecex = 150;
var piecey = 250;
var obstacles = [[0,0,0,0,0,0],
                 [0,0,0,0,0,0],
                 [0,0,0,0,0,0],
                 [0,0,0,0,0,0],
                 [0,0,0,0,0,0],
                 [0,0,0,0,0,0],]
var gamePlay = true;
var total_reward = 0;
var key_presses = 0;
var time_spent = 0;
var len = obstacles[0].length;
var ship_location = len/2;

$(document).ready(function() {
  var gameboard = $("<div id='gameboard'></div>");
  $(document.body).append(gameboard);
  var piece = $("<div class='piece'></div>");
  $(gameboard).append(piece);
  var global = $("<div class='globalpiece'></div>");
  $(gameboard).append(global);
  var reward = $("<div id='reward'>0</div>"); 
  $(document.body).append(reward);
  $(document).keydown(function(e) {
    if (gamePlay) {
      if(e.keyCode==37) {
        key_presses++;
        // left arrow clicked
        if (ship_location == 0) {
          ship_location = len - 1;
        }
        else {
          ship_location -= 1;
        }
        
      } else if(e.keyCode == 39) {
        key_presses++;
      // right arrow clicked
        if (ship_location == len - 1) {
          ship_location = 0;
        }
        else {
          ship_location += 1;
        }
      }
      piecex = ship_location*50;
      $(".piece").css("left", piecex + "px");

      index = parseInt($(".piece").css("left").replace(/[^-\d\.]/g, ''))/50;
      if (obstacles[5][index] == 1) {
        gamePlay = false;
        $("#keyPresses").val(key_presses);
        $("#timeSpent").val(time_spent);
        $("#rewardCollected").val(total_reward/1000);
        $("#mturk-form").submit()
        window.alert("Game Lost. Refresh to Try Again.")
      }
    }
  });
  setInterval(function() {
    if (gamePlay) {
      time_spent += 500;
      total_reward += 10;
      $("#reward").html("$" + total_reward/1000);
      for (i = obstacles.length-1; i > 0; i--) {
        for (j = 0; j < 6; j++) {
        obstacles[i][j] = obstacles[i - 1][j];        
        }
      }
      for (j = 0; j < 6; j++) {
        checker = Math.floor(Math.random() * 5);
        if (checker == 0) {
          obstacles[0][j] = 1; 
        } else {
          obstacles[0][j] = 0;
        }
      }
      $(".obstacle").remove();
      for (i = 0; i < obstacles.length; i++) {
        for (j = 0; j < 6; j++) {
          if (obstacles[i][j] == 1) {
            obstacle = $("<div id='obstacle" + (i*6+j) + "' class='obstacle'></div>");
            $("#gameboard").append(obstacle);
            $("#obstacle" + (i*6+j)).css("left", j * 50 + "px");
            $("#obstacle" + (i*6+j)).css("top", i * 50 + "px");
          }
        }
      }
      globalIndex = parseInt($(".globalpiece").css("left").replace(/[^-\d\.]/g, ''))/50;
      if (obstacles[5][pieceIndex] == 1 || total_reward == 2 * 10000) {
        gamePlay = false;
        $("#keyPresses").val(key_presses);
        $("#timeSpent").val(time_spent);
        $("#rewardCollected").val(total_reward/1000);
        $("#mturk-form").submit()
        window.alert("Game Lost. Refresh to Try Again.")
      }
    }
  }, 500);
})
function doSomething(json) {
  var arr = []; 
  var globalx = 150;
  var globaly = 250;
  console.log("beep")
  for (i = 0; i < json["count"]; i++) {
          var data = eval(JSON.stringify(json["results"][i]["data"]));
          var localship_x = JSON.parse(data)["localship_x"];
          console.log(localship_x);
          arr.push(localship_x);
      }
      
      arr.sort();
      var half = Math.floor(arr.length/2);
      if(arr.length % 2) {
        globalx =  arr[half];
      } else { 
        globalx = (arr[half-1]);
      }
      $(".globalpiece").css("left", globalx + "px");
}

function updateBoard() {

  var data = {
      key: "emem", 
      data: JSON.stringify({localship_x: piecex, active: gamePlay})
  };

  $.ajax({
    url: "http://codingthecrowd.com/counter.php", 

    jsonp: "callback",

    jsonpCallback: "doSomething",

    dataType: "jsonp",

    data: data,

  });
}
</script>


<style>
#gameboard {
  background-image: url("background.jpg");
  width: 300px;
  height: 300px;
  position: relative;
  background-repeat: repeat;
}

#reward {
  border: 3px solid grey;
  width: 125px;
  height: 40px;
  position: relative;
  left: 75px;
  top: 50px;
  text-align: center;
  font-size: 2em;
  color: grey;
}

.obstacle {
  background-image: url("explode.png");
  width: 50px;
  height: 50px;
  position: absolute;
}

.piece {
  background-image: url("ship.png");
  width: 50px;
  height: 50px;
  position: absolute;
  left: 150px;
  top: 250px;
}
.globalpiece {
  background-image: white;
  width: 50px;
  height: 50px;
  position: absolute;
  left: 150px;
  top: 250px;
}
.header_centered{ 
    font-size: 24px;
    text-align:center;
    margin: 30px;
    font-style: bold;
}
</style>
</head>
<body>
</body>
<meta charset="utf-8"/>


</html>
